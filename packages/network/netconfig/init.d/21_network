################################################################################
#      Copyright (C) 2012-2013 FreeLB.org
#      http://www.freelb.org
#
#  This Program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2, or (at your option)
#  any later version.
#
#  This Program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with FreeLB.org; see the file COPYING.  If not, write to
#  the Free Software Foundation, 51 Franklin Street, Suite 500, Boston, MA 02110, USA.
#  http://www.gnu.org/copyleft/gpl.html
################################################################################

# setup networking
#
# runlevels: operations, installer, textmode

NETWORKING_CONFIG=/storage/.config/networking.conf

if [ ! -d /storage/.config ]; then
	mkdir -p /storage/.config
fi

if [ -f $NETWORKING_CONFIG ]; then
	. $NETWORKING_CONFIG
else
	echo -n "" > $NETWORKING_CONFIG
	# configuration doesn't exit create a template
	available_ifaces=""
	for iface in /sys/class/net/eth*; do
		iface=`basename $iface`
		available_ifaces="$available_ifaces $iface"
		IFACE=`echo $iface | tr 'a-z' 'A-Z'`
		echo "# CIDR address for $iface" >> $NETWORKING_CONFIG
		echo "NET_IPCONFIG_${IFACE}=\"\"" >> $NETWORKING_CONFIG
	done
	echo "# GATEWAY" >> $NETWORKING_CONFIG
	echo "NET_GATEWAY=\"\"" >> $NETWORKING_CONFIG
	echo "# DNS (space separated)" >> $NETWORKING_CONFIG
	echo "NET_DNS=\"\"" >> $NETWORKING_CONFIG
	echo "# SEARCH DOMAIN" >> $NETWORKING_CONFIG
	echo "NET_DOMAIN=\"\"" >> $NETWORKING_CONFIG
	echo "# ACTIVE INTERFACES (AVAILABLE INTERFACES : $available_ifaces)" >> $NETWORKING_CONFIG
	echo "NET_ENABLED_INTERFACES=\"\"" >> $NETWORKING_CONFIG
	echo "# HOSTNAME" >> $NETWORKING_CONFIG
	echo "NET_HOSTNAME=\"freelb\"" >> $NETWORKING_CONFIG
	. $NETWORKING_CONFIG
fi

# setup hostname
progress "Setup hostname"
if [ -z $NET_HOSTNAME ]; then
	NET_HOSTNAME="freelb"
fi
echo "$NET_HOSTNAME" > /proc/sys/kernel/hostname

# create /etc/hosts file, useful for gethostbyname(localhost)
progress "creating /etc/hosts"
echo -e "127.0.0.1\tlocalhost $NET_HOSTNAME" > /etc/hosts

# starting loopback device
progress "Setup loopback device"
ifconfig lo up

# starting ethernet devices
for iface in $NET_ENABLED_INTERFACES; do
	IFACE=`echo $iface | tr 'a-z' 'A-Z'`
	if_ipconfig=$(eval "echo \${NET_IPCONFIG_$IFACE}")
	if [ -n "$if_ipconfig" ]; then
		progress "Setup $iface network device"
		ip link set dev $iface up
		ip address add $if_ipconfig dev $iface
	fi
done

if [ -n "$NET_GATEWAY" ]; then
	progress "Setup network gateway"
	ip route add default via $NET_GATEWAY
fi

# remove resolv.conf configuration, we will regenerate it
progress "Setup DNS"
echo -n "" > /etc/resolv.conf

if [ -n "$NET_DOMAIN" ]; then
	echo "search $NET_DOMAIN" >> /etc/resolv.conf
fi

if [ -n "$NET_DNS" ]; then
	for dns in $NET_DNS; do
		echo "nameserver $dns" >> /etc/resolv.conf
	done
fi

# add user defined hosts.conf entry's
[ -f $HOME/.config/hosts.conf ] && cat $HOME/.config/hosts.conf >> /etc/hosts

# set hwclock
if [ -f /proc/driver/rtc ]; then
	(
		# sleep 30 seconds before hw clock is synced
		usleep 30000000
		progress "syncing hardware clock with system clock"
		/sbin/hwclock --systohc
	)&
fi
